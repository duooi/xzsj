<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .game {
            width: 560px;
            margin: 100px auto;
        }

        .game h2 {
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="game">
        <h2>Sokoban Game</h2>
        <canvas id="canvas" width="560" height="560"></canvas>
        <div class="op">
            <p>第<span class="level">1</span>/100关 移动次数: <span class="count">0</span></p>
            <div class="btn_group">
                <button onclick="nextLevel(-1)">上一关</button>
                <button onclick="nextLevel(1)">下一关</button>
                <button onclick="nextLevel(0)">重玩本关</button>
                <button onclick="showGameInfo()">游戏说明</button>
            </div>
        </div>
    </div>

    <script src="js/mapdata100.js"></script>
    <script>
        var canvas = document.querySelector("canvas");
        var ctx = canvas.getContext("2d");

        var curLevel = 1,
            source = {};

        // 推箱子构造函数
        function Sokoban(ctx, go) {
            this.ctx = ctx || document.querySelector("canvas").getContext("2d");
            // 当前关卡
            this.curLevel = go && curLevel + go > 0 ? curLevel += go : curLevel;
            // 总关卡
            this.totalLevels = 100;
            // 人物初始位置
            this.pLocation = {
                x: 0,
                y: 0
            };

            this.init();
        }

        // 游戏初始化
        Sokoban.prototype.init = function () {
            // 按照map数组绘制相应元素
            this.drawMap();

            // 键盘控制人物
            this.direct();
        }

        // 绘制地图
        Sokoban.prototype.drawMap = function (direct) {
            // 获取当前关卡地图
            // 人物的行动方向
            var direct = direct;
            var curMap = levels[this.curLevel - 1];
            for (var i = 0; i < curMap.length; i++) {
                for (var j = 0; j < curMap[i].length; j++) {
                    this.ctx.drawImage(source.block, j * 35, i * 35, 35, 35);
                    // 根据类型绘制相应元素    
                    if (curMap[i][j] == 1) {
                        this.ctx.drawImage(source.wall, j * 35, i * 35 - 11, 35, 46);
                    } else if (curMap[i][j] == 2) {
                        this.ctx.drawImage(source.ball, j * 35 + 3, i * 35 + 3, 30, 30);
                    } else if (curMap[i][j] == 3) {
                        this.ctx.drawImage(source.box, j * 35, i * 35 - 10, 35, 45);
                    } else if (curMap[i][j] == 4) {
                        // 记录人物初始位置
                        this.pLocation = {
                            "x": i,
                            "y": j
                        };
                        switch (direct) {
                            case 0:
                                this.ctx.drawImage(source.pleft, j * 35 - 8, i * 35 - 27, 50, 62);
                                break;
                            case 1:
                                this.ctx.drawImage(source.pup, j * 35 - 8, i * 35 - 27, 50, 62);
                                break;
                            case 2:
                                this.ctx.drawImage(source.pright, j * 35 - 8, i * 35 - 27, 50, 62);
                                break;
                            case 3:
                            default:
                                this.ctx.drawImage(source.pdown, j * 35 - 8, i * 35 - 27, 50, 62);
                                break;
                        }
                    }
                }
            }
        }

        Sokoban.prototype.drawEle = function (type) {

        }

        // 方向控制
        Sokoban.prototype.direct = function () {
            var action = 0,
                _this = this;
            document.onkeydown = function (e) {
                switch (e.keyCode) {
                    // 左
                    case 37:
                        action = 0;
                        _this.personMove(action);
                        break;
                    // 上
                    case 38:
                        action = 1;
                        _this.personMove(action);
                        break;
                    // 右
                    case 39:
                        action = 2;
                        _this.personMove(action);
                        break;
                    // 下
                    case 40:
                        action = 3;
                        _this.personMove(action);
                        break;
                }
            }
        }

        // 人物移动
        Sokoban.prototype.personMove = function (action) {
            // 人物向左移动
            if (action == 0) {
                // 检测是否碰到墙
                if (this.wallHitDect(action)) {
                    // 检测是否碰到箱子
                    if (!this.isBoxPushed(action)) {
                        levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y - 1] = 4;
                        levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y] = 0;
                    }else{
                        levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y - 1]
                    }
                }
                // 人物向上移动
            } else if (action == 1) {
                // 检测是否碰到墙
                if (this.wallHitDect(action)) {
                    // 检测是否碰到箱子
                    if (!this.isBoxPushed(action)) {
                        levels[this.curLevel - 1][this.pLocation.x - 1][this.pLocation.y] = 4;
                        levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y] = 0;
                    }
                }
                // 人物向右移动
            } else if (action == 2) {
                // 检测是否碰到墙
                if (this.wallHitDect(action)) {
                    // 检测是否碰到箱子
                    if (!this.isBoxPushed(action)) {
                        levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y + 1] = 4;
                        levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y] = 0;
                    }
                }
                // 人物向下移动
            } else if (action == 3) {
                // 检测是否碰到墙
                if (this.wallHitDect(action)) {
                    // 检测是否碰到箱子
                    if (!this.isBoxPushed(action)) {
                        levels[this.curLevel - 1][this.pLocation.x + 1][this.pLocation.y] = 4;
                        levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y] = 0;
                    }
                }
            }

            this.drawMap(action);
        }

        // 碰撞检测
        Sokoban.prototype.wallHitDect = function (action) {
            if (action == 0) {
                if (levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y - 1] == 1) return false;
                // 人物向上移动
            } else if (action == 1) {
                if (levels[this.curLevel - 1][this.pLocation.x - 1][this.pLocation.y] == 1) return false;
                // 人物向右移动
            } else if (action == 2) {
                if (levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y + 1] == 1) return false;
                // 人物向下移动
            } else if (action == 3) {
                if (levels[this.curLevel - 1][this.pLocation.x + 1][this.pLocation.y] == 1) return false;
            }
            return true;
        }

        // 判断是否推到箱子
        Sokoban.prototype.isBoxPushed = function (action) {
            if (action == 0) {
                if (levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y - 1] !== 3) return false;
                // 人物向上移动
            } else if (action == 1) {
                if (levels[this.curLevel - 1][this.pLocation.x - 1][this.pLocation.y] !== 3) return false;
                // 人物向右移动
            } else if (action == 2) {
                if (levels[this.curLevel - 1][this.pLocation.x][this.pLocation.y + 1] !== 3) return false;
                // 人物向下移动
            } else if (action == 3) {
                if (levels[this.curLevel - 1][this.pLocation.x + 1][this.pLocation.y] !== 3) return false;
            }
            return true;
        }

        // 图片素材预加载
        function imgPreload(callback) {
            var count = 0,
                length = 0;
            // 素材资源
            var srcs = {
                "ball": "images/ball.png",
                "block": "images/block.gif",
                "box": "images/box.png",
                "pdown": "images/down.png",
                "pleft": "images/left.png",
                "pright": "images/right.png",
                "pup": "images/up.png",
                "wall": "images/wall.png"
            };
            // 统计资源数量
            for (var src in srcs) {
                length++;
            }
            // 资源加载完成后作为属性
            for (var src in srcs) {
                var s = new Image();
                (function (src) {
                    s.onload = function () {
                        source[src] = this;
                        count++;
                        // 如果资源都加载完成后执行回调
                        if (count >= length) {
                            // 页面加载后自动创建推箱子游戏实例
                            new Sokoban();
                        }
                    };
                })(src);
                s.src = srcs[src];
            }
        }

        // 页面第一次加载后自动加载资源素材
        imgPreload();

        // 按钮控制关卡
        function nextLevel(page) {
            if (page == -1) {
                new Sokoban(ctx, -1);
            } else if (page == 0) {
                new Sokoban(ctx, 0);
            } else if (page == 1) {
                new Sokoban(ctx, 1);
            }
            document.querySelector(".level").innerHTML = curLevel;
        }

        // 游戏说明
        function showGameInfo() {
            alert("用键盘上的上、下、左、右键移动小人，把箱子全部推到小球的位置即可过关。箱子只可向前推，不能往后拉，并且小人一次只能推动一个箱子。");
        }
    </script>
</body>

</html>